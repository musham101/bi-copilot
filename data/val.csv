id,user_query,sql_query
33,Find the top-selling product in each year.,"SELECT Year, ProductID, Name, TotalQty FROM (SELECT YEAR(soh.OrderDate) AS Year, p.ProductID, p.Name, SUM(sod.OrderQty) AS TotalQty, ROW_NUMBER() OVER (PARTITION BY YEAR(soh.OrderDate) ORDER BY SUM(sod.OrderQty) DESC) AS rn FROM SalesOrderHeader soh JOIN SalesOrderDetail sod ON soh.SalesOrderID = sod.SalesOrderID JOIN Product p ON sod.ProductID = p.ProductID GROUP BY Year, p.ProductID) AS T WHERE rn = 1;"
31,Retrieve the most expensive product in each category.,"SELECT pc.ProductCategoryID, pc.Name AS Category, p.ProductID, p.Name, p.ListPrice FROM ProductCategory pc JOIN ProductSubcategory ps ON pc.ProductCategoryID = ps.ProductCategoryID JOIN Product p ON ps.ProductSubcategoryID = p.ProductSubcategoryID WHERE p.ListPrice = (SELECT MAX(p2.ListPrice) FROM Product p2 JOIN ProductSubcategory ps2 ON p2.ProductSubcategoryID = ps2.ProductSubcategoryID WHERE ps2.ProductCategoryID = pc.ProductCategoryID);"
40,Which products have the highest and lowest profit margins? List 5 each.,"(SELECT 'Highest Margin' AS MarginType, p.Name AS ProductName, p.ListPrice, p.StandardCost, (p.ListPrice - p.StandardCost) AS ProfitPerUnit, ROUND(((p.ListPrice - p.StandardCost) / p.ListPrice) * 100, 2) AS MarginPercentage FROM Product p WHERE p.ListPrice > 0 AND p.StandardCost > 0 ORDER BY MarginPercentage DESC LIMIT 5) UNION ALL (SELECT 'Lowest Margin' AS MarginType, p.Name AS ProductName, p.ListPrice, p.StandardCost, (p.ListPrice - p.StandardCost) AS ProfitPerUnit, ROUND(((p.ListPrice - p.StandardCost) / p.ListPrice) * 100, 2) AS MarginPercentage FROM Product p WHERE p.ListPrice > 0 AND p.StandardCost > 0 AND (p.ListPrice - p.StandardCost) > 0 ORDER BY MarginPercentage ASC LIMIT 5);"
4,Show all sales orders placed in 2011.,"SELECT SalesOrderID, SalesOrderNumber, OrderDate FROM SalesOrderHeader WHERE YEAR(OrderDate) = 2011;"
18,Customers who purchased more than 100 different products.,"SELECT soh.CustomerID, COUNT(DISTINCT sod.ProductID) AS UniqueProducts FROM SalesOrderHeader soh JOIN SalesOrderDetail sod ON soh.SalesOrderID = sod.SalesOrderID GROUP BY soh.CustomerID HAVING UniqueProducts > 100;"
26,Retrieve all employees who worked in more than 1 department.,"SELECT BusinessEntityID, COUNT(DISTINCT DepartmentID) AS DeptCount FROM EmployeeDepartmentHistory GROUP BY BusinessEntityID HAVING DeptCount > 1;"
13,List all orders shipped to Canada.,"SELECT soh.SalesOrderID, cr.Name AS CountryName FROM SalesOrderHeader soh JOIN Address a ON soh.ShipToAddressID = a.AddressID JOIN StateProvince sp ON a.StateProvinceID = sp.StateProvinceID JOIN CountryRegion cr ON sp.CountryRegionCode = cr.CountryRegionCode WHERE cr.Name = 'Canada';"
38,Which states or provinces bring in the most sales? List top 15.,"SELECT sp.Name AS StateProvince, cr.Name AS Country, SUM(soh.TotalDue) AS TotalSales FROM SalesOrderHeader soh JOIN Address a ON soh.ShipToAddressID = a.AddressID JOIN StateProvince sp ON a.StateProvinceID = sp.StateProvinceID JOIN CountryRegion cr ON sp.CountryRegionCode = cr.CountryRegionCode GROUP BY sp.StateProvinceID, sp.Name, cr.Name ORDER BY TotalSales DESC LIMIT 15;"
46,Retrieve vendors who supply only products in one single category.,SELECT pv.BusinessEntityID FROM ProductVendor pv JOIN Product p ON pv.ProductID = p.ProductID JOIN ProductSubcategory ps ON p.ProductSubcategoryID = ps.ProductSubcategoryID GROUP BY pv.BusinessEntityID HAVING COUNT(DISTINCT ps.ProductCategoryID) = 1;
27,Find products whose list price is above the average list price of their category.,"SELECT p.ProductID, p.Name, p.ListPrice, AvgPrices.AvgListPrice FROM Product p JOIN ProductSubcategory ps ON p.ProductSubcategoryID = ps.ProductSubcategoryID JOIN ProductCategory pc ON ps.ProductCategoryID = pc.ProductCategoryID JOIN (SELECT ps2.ProductCategoryID, AVG(p2.ListPrice) AS AvgListPrice FROM Product p2 JOIN ProductSubcategory ps2 ON p2.ProductSubcategoryID = ps2.ProductSubcategoryID GROUP BY ps2.ProductCategoryID) AS AvgPrices ON pc.ProductCategoryID = AvgPrices.ProductCategoryID WHERE p.ListPrice > AvgPrices.AvgListPrice;"
